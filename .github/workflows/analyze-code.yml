      - name: Compute Additions/Deletions (weekly & lifetime)
        env:
          AUTHOR_FILTER: ${{ secrets.AUTHOR_FILTER }} # optional: e.g. "Pramit|pmazumder@"
        run: |
          set -euo pipefail
          shopt -s nullglob

          EXCLUDE_EXTS='(json|html|css|svg|md|ps1|scss|csv|prefab|unity|asset|meta)$'
          EXCLUDE_DIRS='/(Library|Temp|obj|Build|build|\.git)/'

          unshallow_if_needed() {
            # ensure full history so deletions exist in the log
            if git rev-parse --is-shallow-repository >/dev/null 2>&1; then
              # unshallow only the checked-out branch to keep bandwidth sane
              git fetch --prune --unshallow --tags origin || \
              git fetch --prune --depth=2147483647 --tags origin
            fi
          }

          churn_dir() {
            local root="$1"
            local since="$2"   # "1 week ago" or empty
            local author="${3:-}"
            local total_add=0
            local total_del=0

            for repo in "$root"/*; do
              [ -d "$repo/.git" ] || continue
              pushd "$repo" >/dev/null

              unshallow_if_needed

              # Make sure weâ€™re on the default branch (the clone used --single-branch)
              BR=$(git rev-parse --abbrev-ref HEAD)
              git fetch --quiet origin "$BR" || true

              declare -a ARGS=(--no-merges --numstat --format=%H)
              [ -n "$since" ] && ARGS+=(--since="$since")
              [ -n "$author" ] && ARGS+=(--author="$author")

              read -r add del < <(
                git log "${ARGS[@]}" \
                | awk -v exts="$EXCLUDE_EXTS" -v dirs="$EXCLUDE_DIRS" '
                    NF==1 { next }  # commit hash lines
                    NF>=3 {
                      a=$1; d=$2; file=$3
                      if (a == "-" || d == "-") next  # binary diffs
                      if (file ~ dirs) next
                      if (file ~ exts) next
                      A += a; D += d
                    }
                    END { printf "%d %d", A+0, D+0 }
                  '
              )

              total_add=$((total_add + add))
              total_del=$((total_del + del))
              popd >/dev/null
            done

            printf '{"additions":%d,"deletions":%d}\n' "$total_add" "$total_del"
          }

          mkdir -p output

          PUB_WEEK=$(churn_dir repos/public  "1 week ago" "${AUTHOR_FILTER:-}")
          PRI_WEEK=$(churn_dir repos/private "1 week ago" "${AUTHOR_FILTER:-}")
          echo "$PUB_WEEK" > output/churn-public-week.json
          echo "$PRI_WEEK" > output/churn-private-week.json

          PUB_ALL=$(churn_dir repos/public  "" "${AUTHOR_FILTER:-}")
          PRI_ALL=$(churn_dir repos/private "" "${AUTHOR_FILTER:-}")
          echo "$PUB_ALL" > output/churn-public-all.json
          echo "$PRI_ALL" > output/churn-private-all.json
